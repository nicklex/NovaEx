<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ó–≤–µ–∑–¥–Ω—ã–π –°–∫–∏—Ç–∞–ª–µ—Ü: Nova EX - Deep Mining</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;600;800&display=swap');
        
        body {
            margin: 0; overflow: hidden; background: #010105;
            font-family: 'Exo 2', sans-serif; color: #b0b0ff; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        canvas { display: block; width: 100%; height: 100%; }

        .hud-container {
            position: absolute; inset: 0; pointer-events: none;
            padding: max(10px, env(safe-area-inset-top)) max(10px, env(safe-area-inset-right)) max(10px, env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
            display: flex; flex-direction: column; justify-content: space-between;
            z-index: 100;
        }

        .glass-panel {
            background: rgba(5, 10, 30, 0.92);
            border: 1px solid rgba(0, 212, 255, 0.4);
            box-shadow: 0 0 30px rgba(0, 150, 255, 0.2);
            backdrop-filter: blur(12px) brightness(1.2);
            border-radius: 8px; pointer-events: auto;
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        .stat-label {
            font-family: 'Orbitron', sans-serif; font-size: 0.6rem;
            color: #80deff; text-transform: uppercase; letter-spacing: 2px;
            text-shadow: 0 0 5px #00d4ff;
        }

        .btn-sci-fi {
            font-family: 'Orbitron', sans-serif; background: rgba(0, 212, 255, 0.15);
            border: 1px solid #00d4ff; color: #b0f0ff; padding: 12px 20px;
            font-size: 0.8rem; cursor: pointer; transition: 0.2s;
            clip-path: polygon(8% 0, 100% 0, 92% 100%, 0% 100%);
            text-transform: uppercase; letter-spacing: 3px;
            font-weight: 600; text-shadow: 0 0 8px #00d4ff;
            -webkit-touch-callout: none;
        }

        .btn-sci-fi:active:not(:disabled) {
            background: #00d4ff; color: #000; box-shadow: 0 0 30px #00d4ff;
            transform: scale(0.96);
        }

        /* –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï */
        .mobile-controls {
            position: absolute; bottom: 30px; left: 0; right: 0;
            display: flex; justify-content: space-between; padding: 20px;
            pointer-events: none; z-index: 5000;
        }

        .joystick-area {
            width: 130px; height: 130px; background: rgba(0, 20, 40, 0.7);
            backdrop-filter: blur(8px); border: 2px solid #00d4ff;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 40px rgba(0,212,255,0.3);
            pointer-events: auto; position: relative;
        }

        .joystick-knob {
            width: 50px; height: 50px; background: radial-gradient(circle at 30% 30%, #fff, #00a0ff);
            border-radius: 50%; box-shadow: 0 0 20px #00d4ff;
            transition: 0.02s;
        }

        .fire-btn {
            width: 130px; height: 130px; background: radial-gradient(circle, rgba(255,80,80,0.25), rgba(200,0,0,0.4));
            border: 3px solid #ff4444; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron'; font-weight: 900; font-size: 1.6rem;
            color: white; text-shadow: 0 0 20px red;
            box-shadow: 0 0 50px rgba(255,0,0,0.5);
            pointer-events: auto; backdrop-filter: blur(6px);
        }

        .fire-btn:active {
            background: radial-gradient(circle, rgba(255,100,100,0.8), rgba(255,0,0,0.9));
            transform: scale(0.9);
        }

        @media (max-width: 768px) {
            .hud-container .glass-panel { padding: 12px; }
            .stat-label { font-size: 0.55rem; }
            .text-2xl { font-size: 1.2rem; }
            .minimap-container { width: 120px; height: 120px; bottom: 200px; }
        }

        #overlay-screen {
            position: fixed; inset: 0; background: radial-gradient(circle at 30% 40%, #0a0a1a 0%, #000 100%);
            z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* –ó–≤–µ–∑–¥–Ω–æ–µ –Ω–µ–±–æ –≤ –º–µ–Ω—é */
        .stars-bg {
            position: absolute; width: 100%; height: 100%;
            background: transparent;
            background-image: 
                radial-gradient(2px 2px at 10px 30px, #fff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 90px 140px, #aaf, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 160px 80px, #ccf, rgba(0,0,0,0));
            background-size: 200px 200px;
            opacity: 0.6;
            animation: starFloat 40s linear infinite;
        }

        @keyframes starFloat {
            0% { background-position: 0 0, 0 0, 0 0; }
            100% { background-position: 400px 400px, -200px 200px, 300px -100px; }
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–π –∫–æ—Å–º–æ—Å: —Ç—É–º–∞–Ω–Ω–æ—Å—Ç–∏ */
        .nebula-effect {
            position: fixed; inset: 0; pointer-events: none;
            background: radial-gradient(circle at 70% 30%, rgba(20,40,100,0.2) 0%, transparent 50%),
                        radial-gradient(circle at 20% 80%, rgba(80,20,100,0.15) 0%, transparent 55%),
                        radial-gradient(circle at 90% 70%, rgba(0,100,150,0.1) 0%, transparent 60%);
            z-index: 50;
        }

        .save-indicator.active { color: #00ffaa; text-shadow: 0 0 10px #00ffaa; }
    </style>
</head>
<body>

<!-- –§–æ–Ω–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Ç—É–º–∞–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–æ—Å–º–æ—Å–∞ (–±—É–¥–µ—Ç –≤–∏–¥–µ–Ω —Å–∫–≤–æ–∑—å canvas) -->
<div class="nebula-effect" id="nebulaBg" style="display: none;"></div>

<div id="overlay-screen">
    <div class="stars-bg"></div>
    <h1 class="text-7xl font-black mb-2 tracking-[0.5em] text-white font-['Orbitron'] drop-shadow-[0_0_30px_#00d4ff]">NOVA EX</h1>
    <p class="text-blue-400 mb-12 tracking-[0.3em] text-sm italic opacity-90 font-['Orbitron']">COSMIC MINER & PILOT</p>
    
    <div class="flex flex-col gap-5 w-72 relative z-10">
        <button id="btn-continue" onclick="startGame(false)" class="btn-sci-fi py-5 text-lg border-green-500 text-green-400 hidden" style="background: rgba(16, 185, 129, 0.2);">
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—É—Ç—å
        </button>
        <button onclick="startGame(true)" class="btn-sci-fi py-5 text-lg">–ù–æ–≤–∞—è —ç–∫—Å–ø–µ–¥–∏—Ü–∏—è</button>
    </div>

    <div id="save-status" class="save-indicator mt-8">
        <span class="w-2 h-2 rounded-full bg-current"></span>
        <span>–ü–†–û–í–ï–†–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–ô</span>
    </div>

    <div class="mt-12 text-[10px] text-gray-500 uppercase tracking-wider text-center px-4 leading-relaxed">
        <span class="block md:hidden">‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è - –î–≤–∏–∂–µ–Ω–∏–µ (—Å—Ç–∏–∫)<br>üî• - –û–≥–æ–Ω—å<br>üëÜ –ö–Ω–æ–ø–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span>
        <span class="hidden md:block">W - –î–≤–∏–≥–∞—Ç–µ–ª—å (–ª–µ—Ç–∏—Ç –∫ –∫—É—Ä—Å–æ—Ä—É)<br>–ú—ã—à–∫–∞ - –ü–æ–≤–æ—Ä–æ—Ç –∏ –û–≥–æ–Ω—å (–õ–ö–ú)</span>
    </div>
</div>

<div class="hud-container" id="game-hud" style="display: none;">
    <div class="flex justify-between items-start gap-2 flex-wrap">
        <div class="glass-panel p-3 flex gap-4 flex-wrap">
            <div class="flex flex-col">
                <span class="stat-label">–ö—Ä–µ–¥–∏—Ç—ã</span>
                <span class="text-2xl font-bold text-white drop-shadow-[0_0_8px_cyan]"><span id="coins">0</span> üí≥</span>
            </div>
            <div class="flex flex-col">
                <span class="stat-label">–ì—Ä—É–∑</span>
                <div class="flex items-end gap-1">
                    <span class="text-2xl font-bold text-cyan-400" id="cargo">0</span>
                    <span class="text-xs opacity-50 mb-1">/ <span id="maxCargo">10</span></span>
                </div>
                <div id="cargo-type" class="text-[9px] text-blue-300 font-bold uppercase"></div>
            </div>
            <div class="flex flex-col w-36">
                <span class="stat-label text-red-400">–ö–æ—Ä–ø—É—Å</span>
                <div class="h-2.5 bg-gray-900/80 mt-1 rounded-sm overflow-hidden border border-red-500/50">
                    <div id="hp-bar" class="h-full bg-gradient-to-r from-red-600 to-orange-400" style="width: 100%"></div>
                </div>
                <span class="text-xs text-right text-white/70"><span id="hp-text">100</span>/<span id="max-hp-text">100</span></span>
            </div>
        </div>
        <div class="glass-panel p-3 text-right hidden sm:block">
            <span class="stat-label">–£—Ä.</span>
            <div class="text-white text-xs mt-1 font-['Orbitron']">
                –î–≤–≥ <span id="eng-lvl">1</span> ‚Ä¢ –©–∏—Ç <span id="shd-lvl">1</span> ‚Ä¢ –û—Ä <span id="dmg-lvl">1</span> ‚Ä¢ –ö–æ—Ä–ø <span id="hull-lvl">1</span>
            </div>
        </div>
    </div>

    <div id="quest-hud" class="glass-panel p-3 w-72 mt-2 border-l-4 border-l-yellow-500" style="display: none;">
        <span class="stat-label">–ö–æ–Ω—Ç—Ä–∞–∫—Ç</span>
        <div id="quest-desc" class="text-white text-xs mt-1 font-semibold">...</div>
    </div>

    <div class="flex justify-between items-end">
        <div class="glass-panel p-2 px-5 mb-4">
            <span class="stat-label">–°–µ–∫—Ç–æ—Ä</span>
            <div id="sector-name" class="text-lg font-bold text-white font-['Orbitron'] uppercase tracking-wider">---</div>
        </div>
    </div>
</div>

<div id="minimap-ui" class="minimap-container" style="display: none; bottom: 200px; right: 20px;">
    <canvas id="minimapCanvas" width="180" height="180"></canvas>
</div>

<!-- –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï (–≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–∞—Ö < 768px) -->
<div class="mobile-controls md:hidden" id="mobileControls" style="display: none;">
    <div class="joystick-area" id="joystickArea">
        <div class="joystick-knob" id="joystickKnob"></div>
    </div>
    <div class="fire-btn" id="fireBtn">
        ‚ö°
    </div>
</div>

<!-- NPC –î–∏–∞–ª–æ–≥, –ú–∞–≥–∞–∑–∏–Ω, –ü—Ä–æ–¥–∞–∂–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
<div id="dialog-ui" class="glass-panel p-5 w-[90vw] max-w-[450px] fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-3000" style="display: none;">
    <div class="flex gap-3 items-center mb-3 border-b border-white/10 pb-3">
        <div class="w-12 h-12 bg-blue-600/30 rounded-lg flex items-center justify-center text-2xl border border-blue-500/50">üë®‚ÄçüöÄ</div>
        <div>
            <h3 class="font-['Orbitron'] text-blue-400 font-bold">–ö–æ–º–∞–Ω–¥–æ—Ä –í–∞—Ä–∫–∞—Å</h3>
            <p class="text-[9px] text-gray-400 uppercase">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä</p>
        </div>
    </div>
    <p id="dialog-text" class="text-sm text-gray-200 mb-6 italic">...</p>
    <div class="flex gap-2">
        <button onclick="acceptQuest()" class="btn-sci-fi flex-1 text-xs">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
        <button onclick="closeDialog()" class="btn-sci-fi bg-red-900/30 border-red-900/60 text-red-400 text-xs">‚ùå –û—Ç–∫–∞–∑</button>
    </div>
</div>

<div id="shop-ui" class="glass-panel p-5 w-[95vw] max-w-[500px] fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-3000" style="display: none;">
    <h2 class="font-bold text-lg tracking-tighter text-blue-400 font-['Orbitron'] mb-4 uppercase border-b border-blue-500/20 pb-2">üõ∏ –ú–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏—è</h2>
    <div class="grid grid-cols-1 gap-3 max-h-[60vh] overflow-y-auto pr-1" id="shop-items"></div>
    <button onclick="closeShop()" class="btn-sci-fi mt-5 w-full opacity-70 text-sm">–ó–∞–∫—Ä—ã—Ç—å –¥–æ–∫</button>
</div>

<div id="sell-ui" class="glass-panel p-5 w-[90vw] max-w-[400px] fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-3000" style="display: none;">
    <h2 class="font-bold text-lg tracking-tighter text-yellow-500 font-['Orbitron'] mb-3 uppercase">üí∞ –°–∫—É–ø–∫–∞</h2>
    <div id="sell-info" class="mb-4">
        <p class="text-xs text-gray-400">–¢–µ–∫—É—â–∏–π –≥—Ä—É–∑:</p>
        <p id="sell-cargo-desc" class="text-lg font-bold text-white mt-1">---</p>
    </div>
    <div class="flex flex-col gap-2">
        <button id="btn-sell-action" onclick="sellCargo()" class="btn-sci-fi border-yellow-500 text-yellow-500 hover:bg-yellow-500/20 text-sm">–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë –∑–∞ <span id="sell-price">0</span> üí≥</button>
        <button onclick="closeSell()" class="btn-sci-fi opacity-60 text-sm">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const SFX = {
    ctx: null,
    init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    play(freq, type = 'sine', duration = 0.1, vol = 0.1) {
        if (!this.ctx) return;
        if (this.ctx.state === 'suspended') this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain); gain.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + duration);
    },
    shoot() { this.play(600, 'square', 0.08, 0.04); },
    hit() { this.play(120, 'sawtooth', 0.15, 0.08); },
    pickup() { this.play(900, 'sine', 0.12, 0.07); },
    ui() { this.play(700, 'sine', 0.04, 0.04); },
    repair() { this.play(250, 'sine', 0.5, 0.05); }
};

const TIERS = [
    { id: 0, name: '–ö–µ–ø–ª–µ—Ä-–ê', ore: '–ñ–µ–ª–µ–∑–æ', color: '#95a5a6', bgColor: '#0a0c0e', price: 15, enemyColor: '#dddddd' },
    { id: 1, name: '–ú–∞–≥–º–∞-4', ore: '–°–µ—Ä–∞', color: '#e67e22', bgColor: '#1a0c00', price: 35, enemyColor: '#ff8844' },
    { id: 2, name: '–¶–∏–∞–Ω-9', ore: '–ú–µ—Ç–∞–Ω', color: '#1abc9c', bgColor: '#00221e', price: 75, enemyColor: '#44ffff' },
    { id: 3, name: '–õ–µ–¥—è–Ω–æ–π –ü–∏–∫', ore: '–ö—Ä–∏—Å—Ç–∞–ª–ª', color: '#a0d6ff', bgColor: '#0e1a24', price: 150, enemyColor: '#cceeff' },
    { id: 4, name: '–¢–∏—Ç–∞–Ω-X', ore: '–¢–∏—Ç–∞–Ω', color: '#5d6d7e', bgColor: '#0a0f14', price: 300, enemyColor: '#99aabb' },
    { id: 5, name: '–ö—Å–µ–Ω–æ–Ω-–ì', ore: '–ò–∑–æ—Ç–æ–ø', color: '#b183c0', bgColor: '#1a0f1a', price: 650, enemyColor: '#dd88ff' },
    { id: 6, name: '–ó–æ–ª–æ—Ç–∞—è –û—Å–∞', ore: '–ó–æ–ª–æ—Ç–æ', color: '#f4d03f', bgColor: '#2a1f00', price: 1400, enemyColor: '#ffffaa' },
    { id: 7, name: '–Ø–¥–æ–≤–∏—Ç—ã–π –ü–ª—é—â', ore: '–¢–æ–∫—Å–∏–Ω', color: '#2ecc71', bgColor: '#0a1f0a', price: 3000, enemyColor: '#88ff88' },
    { id: 8, name: '–û–±—Å–∏–¥–∏–∞–Ω', ore: '–ú–∞—Ç–µ—Ä–∏—è', color: '#424949', bgColor: '#080808', price: 6500, enemyColor: '#aaaaaa' },
    { id: 9, name: '–°–∏–Ω–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å', ore: '–ê–Ω—Ç–∏–≤–µ—â–µ—Å—Ç–≤–æ', color: '#d98880', bgColor: '#1a0a0a', price: 20000, enemyColor: '#ff8888' }
];

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const mCanvas = document.getElementById('minimapCanvas');
const mCtx = mCanvas.getContext('2d');

let gameState = 'MENU';
let activeQuest = null;
let currentPlanet = null;
let mouse = { x: 0, y: 0, down: false };

let player = {
    x: 400, y: 300, vx: 0, vy: 0, angle: 0,
    accel: 0.2, friction: 0.98,
    hp: 100, maxHp: 100, coins: 100, cargo: 0, maxCargo: 10,
    cargoType: null, damage: 20,
    upgrades: { engine: 1, shield: 1, damage: 1, cargo: 1, hull: 1 }
};

let planets = [], bullets = [], particles = [], enemies = [], planetResources = [], stars = [];
let keys = {};
let lastShot = 0;

// === –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï ===
let mobileThrust = { x: 0, y: 0 };
let isMobile = false;

function initMobileControls() {
    const joystick = document.getElementById('joystickArea');
    const knob = document.getElementById('joystickKnob');
    const fireBtn = document.getElementById('fireBtn');

    if (!joystick) return;

    let activeJoystick = false;

    const handleTouch = (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = joystick.getBoundingClientRect();
        const centerX = rect.left + rect.width/2;
        const centerY = rect.top + rect.height/2;
        let dx = touch.clientX - centerX;
        let dy = touch.clientY - centerY;
        const dist = Math.min(35, Math.hypot(dx, dy));
        const angle = Math.atan2(dy, dx);
        mobileThrust.x = Math.cos(angle) * (dist / 35);
        mobileThrust.y = Math.sin(angle) * (dist / 35);
        knob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
    };

    joystick.addEventListener('touchstart', (e) => {
        activeJoystick = true;
        handleTouch(e);
    });
    joystick.addEventListener('touchmove', (e) => { if (activeJoystick) handleTouch(e); });
    joystick.addEventListener('touchend', () => {
        activeJoystick = false;
        mobileThrust = { x: 0, y: 0 };
        knob.style.transform = 'translate(0px, 0px)';
    });

    // –°—Ç—Ä–µ–ª—å–±–∞
    fireBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        mouse.down = true;
        SFX.init();
    });
    fireBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        mouse.down = false;
    });

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    isMobile = window.innerWidth <= 768;
    if (isMobile) {
        document.getElementById('mobileControls').style.display = 'flex';
    }
}

// === –ö–û–°–ú–û–°: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤–µ–∑–¥–Ω—ã—Ö —Å–∫–æ–ø–ª–µ–Ω–∏–π –∏ —Ç—É–º–∞–Ω–Ω–æ—Å—Ç–∏ ===
function generateDeepSpaceStars() {
    stars = [];
    for(let i=0; i<2000; i++) {
        let x = Math.random() * 40000 - 20000;
        let y = Math.random() * 40000 - 20000;
        let size = Math.random() * 2.2;
        let alpha = Math.random() * 0.7 + 0.3;
        // –î–æ–±–∞–≤–ª—è–µ–º —Ü–≤–µ—Ç–Ω—ã–µ –∑–≤–µ–∑–¥—ã
        let color = `rgba(255,255,255,${alpha})`;
        if (Math.random() > 0.8) color = `rgba(180,230,255,${alpha})`; // –≥–æ–ª—É–±—ã–µ
        if (Math.random() > 0.9) color = `rgba(255,200,150,${alpha})`; // —Ç–µ–ø–ª—ã–µ
        stars.push({ x, y, size, alpha, color });
    }
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ–Ω–æ–≤—ã–µ —Ç—É–º–∞–Ω–Ω–æ—Å—Ç–∏ (—Ä–µ–Ω–¥–µ—Ä–∏–º –æ—Ç–¥–µ–ª—å–Ω–æ)
    document.getElementById('nebulaBg').style.display = 'block';
}

function init() {
    window.addEventListener('resize', () => { 
        canvas.width = window.innerWidth; 
        canvas.height = window.innerHeight; 
        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ UI
        isMobile = window.innerWidth <= 768;
        if (isMobile) document.getElementById('mobileControls').style.display = 'flex';
        else document.getElementById('mobileControls').style.display = 'none';
    });
    window.dispatchEvent(new Event('resize'));

    generateDeepSpaceStars();

    planets = TIERS.map((t, i) => ({
        ...t, x: Math.cos(i * 0.9) * (3500 + i * 1500), y: Math.sin(i * 0.9) * (3500 + i * 1500), radius: 140 + i * 30
    }));

    window.addEventListener('keydown', e => { keys[e.code] = true; SFX.init(); });
    window.addEventListener('keyup', e => keys[e.code] = false);
    
    // –ú—ã—à—å –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
    window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
    window.addEventListener('mousedown', () => { mouse.down = true; SFX.init(); });
    window.addEventListener('mouseup', () => mouse.down = false);
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–∞ –∫–∞–Ω–≤–∞—Å–µ
    canvas.addEventListener('contextmenu', (e) => e.preventDefault());

    checkSaveData();
    
    initMobileControls();
    
    requestAnimationFrame(gameLoop);
}

function checkSaveData() {
    const savedData = localStorage.getItem('nova_deep_save');
    const btnContinue = document.getElementById('btn-continue');
    const saveStatus = document.getElementById('save-status');

    if (savedData) {
        btnContinue.classList.remove('hidden');
        saveStatus.classList.add('active');
        saveStatus.innerHTML = '<span class="w-2 h-2 rounded-full bg-current animate-pulse"></span><span>–°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ê–ô–î–ï–ù–û</span>';
    } else {
        btnContinue.classList.add('hidden');
        saveStatus.classList.remove('active');
        saveStatus.innerHTML = '<span class="w-2 h-2 rounded-full bg-white/20"></span><span class="opacity-40">–ù–ï–¢ –°–û–•–†–ê–ù–ï–ù–ò–ô</span>';
    }
}

function startGame(isNew) {
    if (!isNew && localStorage.getItem('nova_deep_save')) {
        const save = JSON.parse(localStorage.getItem('nova_deep_save'));
        player = save.player; 
        activeQuest = save.activeQuest;
    } else {
        player = {
            x: 400, y: 300, vx: 0, vy: 0, angle: 0,
            accel: 0.2, friction: 0.98,
            hp: 100, maxHp: 100, coins: 100, cargo: 0, maxCargo: 10,
            cargoType: null, damage: 20,
            upgrades: { engine: 1, shield: 1, damage: 1, cargo: 1, hull: 1 }
        };
        activeQuest = null;
    }
    gameState = 'STATION';
    document.getElementById('overlay-screen').style.display = 'none';
    document.getElementById('game-hud').style.display = 'flex';
    document.getElementById('minimap-ui').style.display = 'block';
    document.getElementById('nebulaBg').style.display = 'block';
    if (isMobile) document.getElementById('mobileControls').style.display = 'flex';
    SFX.ui();
}

function update() {
    if (gameState === 'MENU') return;

    // –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø–æ–≤–æ—Ä–æ—Ç –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–≤–∏–∂–µ–Ω–∏—è –∏–ª–∏ –∫ —Ü–µ–ª–∏
    if (isMobile && (mobileThrust.x !== 0 || mobileThrust.y !== 0)) {
        player.angle = Math.atan2(mobileThrust.y, mobileThrust.x);
        // –î–≤–∏–≥–∞–µ–º
        player.vx += Math.cos(player.angle) * (player.accel + player.upgrades.engine * 0.03) * Math.hypot(mobileThrust.x, mobileThrust.y);
        player.vy += Math.sin(player.angle) * (player.accel + player.upgrades.engine * 0.03) * Math.hypot(mobileThrust.x, mobileThrust.y);
        spawnParticle(player.x - Math.cos(player.angle)*18, player.y - Math.sin(player.angle)*18, '#00d4ff', 1);
    } else if (keys['KeyW']) {
        player.vx += Math.cos(player.angle) * (player.accel + player.upgrades.engine * 0.03);
        player.vy += Math.sin(player.angle) * (player.accel + player.upgrades.engine * 0.03);
        spawnParticle(player.x - Math.cos(player.angle)*18, player.y - Math.sin(player.angle)*18, '#00d4ff', 1);
    }

    // –ü–æ–≤–æ—Ä–æ—Ç –∏–≥—Ä–æ–∫–∞ –∫ –º—ã—à–∏ (–¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞) –∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö - –∫ —Ü–µ–ª–∏, –µ—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∏–∫–∞
    if (!isMobile || (mobileThrust.x === 0 && mobileThrust.y === 0)) {
        const dx = mouse.x - canvas.width / 2;
        const dy = mouse.y - canvas.height / 2;
        if (Math.hypot(dx, dy) > 10) player.angle = Math.atan2(dy, dx);
    }

    // –°—Ç—Ä–µ–ª—å–±–∞
    if (mouse.down && Date.now() - lastShot > 220 - (player.upgrades.damage * 4)) {
        bullets.push({
            x: player.x + Math.cos(player.angle)*25, y: player.y + Math.sin(player.angle)*25,
            vx: Math.cos(player.angle) * 16 + player.vx, vy: Math.sin(player.angle) * 16 + player.vy,
            life: 65, owner: 'player', damage: player.damage
        });
        lastShot = Date.now(); SFX.shoot();
    }

    player.x += player.vx; player.y += player.vy;
    player.vx *= player.friction; player.vy *= player.friction;

    if (gameState === 'STATION') updateStation();
    else if (gameState === 'SPACE') updateSpace();
    else if (gameState === 'PLANET') updatePlanet();

    bullets.forEach((b, i) => { b.x += b.vx; b.y += b.vy; b.life--; if (b.life <= 0) bullets.splice(i, 1); });
    particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.life -= 0.02; if (p.life <= 0) particles.splice(i, 1); });
    updateUI();
}

function updateStation() {
    if (player.hp < player.maxHp) { player.hp = player.maxHp; SFX.repair(); }
    if (Math.hypot(player.x - 700, player.y - 300) < 80) {
        if(document.getElementById('shop-ui').style.display !== 'block') { 
            document.getElementById('shop-ui').style.display = 'block'; 
            populateShop(); saveData(); 
        }
    } else closeShop();
    if (Math.hypot(player.x - 500, player.y - 300) < 80) { 
        if(document.getElementById('sell-ui').style.display !== 'block') { openSell(); saveData(); }
    } else closeSell();
    if (Math.hypot(player.x - 400, player.y - 600) < 70) {
        if (!activeQuest && document.getElementById('dialog-ui').style.display !== 'block') {
            document.getElementById('dialog-ui').style.display = 'block';
            document.getElementById('dialog-text').innerText = "–ü–∏–ª–æ—Ç, –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å: –ø–µ—Ä–µ–≤–æ–∑–∫–∏ –∏–ª–∏ –æ—Ö—Ä–∞–Ω–∞. –•–æ—Ä–æ—à–∞—è –æ–ø–ª–∞—Ç–∞!";
            saveData(); 
        }
    } else closeDialog();
    if (Math.hypot(player.x - 150, player.y - 300) < 70) { gameState = 'SPACE'; player.x = 400; player.y = 0; player.vx = 4; saveData(); }
}

function updateSpace() {
    if (Math.hypot(player.x, player.y) < 220) { gameState = 'STATION'; player.x = 250; player.y = 300; player.vx = 0; player.vy = 0; }
    planets.forEach(p => {
        const d = Math.hypot(player.x - p.x, player.y - p.y);
        if (d < p.radius + 20) {
            if (player.upgrades.shield >= p.id + 1) landOnPlanet(p);
            else { player.hp -= 0.4; player.vx = (player.x - p.x) * 0.1; player.vy = (player.y - p.y) * 0.1; SFX.hit(); }
        }
    });

    const distFromBase = Math.hypot(player.x, player.y);
    const difficultyLevel = Math.min(9, Math.floor(distFromBase / 1800));
    if (enemies.length < 4 + difficultyLevel) {
        const tier = difficultyLevel;
        enemies.push({ 
            x: player.x + (Math.random()-0.5)*3500, y: player.y + (Math.random()-0.5)*3500, 
            hp: 50 + tier * 120, maxHp: 50 + tier * 120, tier: tier, radius: 18 + tier, 
            color: TIERS[tier]?.enemyColor || '#ff00ff', isSpaceEnemy: true
        });
    }
    handleCombat(enemies);
}

function landOnPlanet(p) {
    currentPlanet = p; gameState = 'PLANET';
    player.x = 0; player.y = 0; player.vx = 0; player.vy = 0;
    planetResources = []; enemies = [];
    for(let i=0; i<10 + p.id*3; i++) planetResources.push({ x: (Math.random()-0.5)*1700, y: (Math.random()-0.5)*1700, collected: false });
    for(let i=0; i<3 + p.id; i++) enemies.push({ 
        x: (Math.random()-0.5)*1400, y: (Math.random()-0.5)*1400, 
        hp: 40 + p.id*55, maxHp: 40 + p.id*55, radius: 17, color: p.enemyColor, tier: p.id 
    });
    SFX.ui();
}

function updatePlanet() {
    if (Math.hypot(player.x, player.y) > 1000) {
        gameState = 'SPACE';
        const a = Math.atan2(player.y, player.x);
        player.x = currentPlanet.x + Math.cos(a)*(currentPlanet.radius + 80);
        player.y = currentPlanet.y + Math.sin(a)*(currentPlanet.radius + 80);
        player.vx = Math.cos(a)*6; player.vy = Math.sin(a)*6;
    }
    planetResources.forEach(res => {
        if (!res.collected && Math.hypot(player.x - res.x, player.y - res.y) < 45) {
            if (player.cargo < player.maxCargo) {
                if (player.cargoType && player.cargoType !== currentPlanet.ore) return;
                res.collected = true; player.cargo++; player.cargoType = currentPlanet.ore;
                SFX.pickup();
                if (activeQuest && activeQuest.type === 'collect' && activeQuest.target === currentPlanet.ore) {
                    activeQuest.progress++; if (activeQuest.progress >= activeQuest.goal) completeQuest();
                }
            }
        }
    });
    handleCombat(enemies);
}

function handleCombat(targets) {
    targets.forEach((en, i) => {
        const d = Math.hypot(player.x - en.x, player.y - en.y);
        if (d < 750) {
            const a = Math.atan2(player.y - en.y, player.x - en.x);
            en.x += Math.cos(a) * 2.5; en.y += Math.sin(a) * 2.5;
            if (d < 400 && Math.random() < 0.025) {
                bullets.push({ x: en.x, y: en.y, vx: Math.cos(a)*9, vy: Math.sin(a)*9, life: 50, owner: 'enemy', damage: 3 + (en.tier||0) });
            }
        }
        bullets.forEach((b, bi) => {
            if (b.owner === 'player' && Math.hypot(b.x - en.x, b.y - en.y) < en.radius + 5) {
                en.hp -= b.damage; bullets.splice(bi, 1); SFX.hit();
                if (en.hp <= 0) {
                    targets.splice(i, 1); player.coins += 20 + (en.tier||0)*30;
                    spawnExplosion(en.x, en.y, en.color, 10);
                    if (activeQuest && activeQuest.type === 'kill') { activeQuest.progress++; if (activeQuest.progress >= activeQuest.goal) completeQuest(); }
                }
            }
        });
    });
    bullets.forEach((b, bi) => {
        if (b.owner === 'enemy' && Math.hypot(b.x - player.x, b.y - player.y) < 18) {
            player.hp -= b.damage || 5; bullets.splice(bi, 1); SFX.hit();
            if (player.hp <= 0) die();
        }
    });
}

function die() { 
    player.hp = player.maxHp; 
    player.x = 250; player.y = 300; 
    player.vx = 0; player.vy = 0; 
    player.cargo = 0; 
    gameState = 'STATION'; 
    saveData(); 
}

// === –£–õ–£–ß–®–ï–ù–ù–´–ô –ö–û–°–ú–û–°: –∑–≤–µ–∑–¥—ã, —Ç—É–º–∞–Ω–Ω–æ—Å—Ç–∏ ===
function drawSpace() {
    // –†–∏—Å—É–µ–º –∑–≤–µ–∑–¥—ã —Å –ø–∞—Ä–∞–ª–ª–∞–∫—Å–æ–º –∏ –º–µ—Ä—Ü–∞–Ω–∏–µ–º
    stars.forEach(s => {
        ctx.fillStyle = s.color || `rgba(255,255,255,${s.alpha * (0.8 + Math.sin(Date.now()*0.001 + s.x)*0.2)})`;
        ctx.fillRect(s.x, s.y, s.size, s.size);
    });

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥—ã–º–∫–∞/—Ç—É–º–∞–Ω–Ω–æ—Å—Ç—å –Ω–∞ –¥–∞–ª—å–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
    ctx.save();
    ctx.globalAlpha = 0.15;
    ctx.filter = 'blur(25px)';
    for (let i=0; i<5; i++) {
        let nx = (Math.sin(Date.now()*0.0001 + i)*5000) % 20000;
        let ny = (Math.cos(Date.now()*0.00015 + i)*5000) % 20000;
        ctx.fillStyle = `rgba(${80+i*20}, ${50+i*10}, 180, 0.1)`;
        ctx.beginPath(); ctx.arc(nx, ny, 800, 0, Math.PI*2); ctx.fill();
    }
    ctx.restore();

    // –ë–∞–∑–∞
    ctx.save();
    ctx.strokeStyle = '#00d4ff'; ctx.lineWidth = 3;
    ctx.shadowBlur = 20; ctx.shadowColor = '#00d4ff';
    ctx.beginPath(); ctx.arc(0, 0, 130, 0, Math.PI*2); ctx.stroke();
    ctx.fillStyle = 'rgba(0, 212, 255, 0.15)'; ctx.fill();
    ctx.fillStyle = '#fff'; ctx.font = "bold 16px Orbitron"; ctx.textAlign = "center";
    ctx.fillText("–°–¢–ê–ù–¶–ò–Ø –ê–õ–¨–§–ê", 0, -160);
    ctx.restore();

    // –ü–ª–∞–Ω–µ—Ç—ã —Å —Å–∏—è–Ω–∏–µ–º
    planets.forEach(p => {
        ctx.save();
        ctx.shadowBlur = 35; ctx.shadowColor = p.color;
        const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.radius);
        g.addColorStop(0, p.color); g.addColorStop(0.8, '#000');
        ctx.fillStyle = g; ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2); ctx.fill();
        ctx.restore();

        ctx.strokeStyle = player.upgrades.shield >= p.id+1 ? '#00ffaa' : '#ff5555';
        ctx.setLineDash([6, 10]); ctx.beginPath(); ctx.arc(p.x, p.y, p.radius+18, 0, Math.PI*2); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = '#fff'; ctx.font = "bold 14px Orbitron"; ctx.shadowBlur = 10; ctx.shadowColor = '#00d4ff';
        ctx.fillText(`${p.name} (T${p.id+1})`, p.x, p.y - p.radius - 30);
        ctx.shadowBlur = 0;
    });
}

function draw() {
    if (gameState === 'MENU') return;
    
    // –§–æ–Ω —Å –≥–ª—É–±–æ–∫–∏–º –∫–æ—Å–º–æ—Å–æ–º (–≤—Å–µ–≥–¥–∞ —á–µ—Ä–Ω—ã–π —Å —Ç—É–º–∞–Ω–Ω–æ—Å—Ç—è–º–∏)
    ctx.fillStyle = '#03030a'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.translate(canvas.width/2 - player.x, canvas.height/2 - player.y);

    if (gameState === 'STATION') drawStation();
    else if (gameState === 'SPACE') drawSpace();
    else drawPlanetSurface();

    particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); });
    ctx.globalAlpha = 1;

    enemies.forEach(en => {
        ctx.shadowBlur = 15; ctx.shadowColor = en.color;
        ctx.fillStyle = en.color; ctx.beginPath(); ctx.arc(en.x, en.y, en.radius, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.fillRect(en.x - 20, en.y - en.radius - 12, 40, 5);
        ctx.fillStyle = '#ff2222'; ctx.fillRect(en.x - 20, en.y - en.radius - 12, 40 * (Math.max(0, en.hp) / en.maxHp), 5);
    });

    bullets.forEach(b => { ctx.fillStyle = b.owner === 'player' ? '#00ffff' : '#ff44aa'; ctx.shadowBlur = 12; ctx.shadowColor = b.owner === 'player' ? '#00d4ff' : '#ff00aa'; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });
    ctx.shadowBlur = 0;

    // –ö–æ—Ä–∞–±–ª—å –∏–≥—Ä–æ–∫–∞
    ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(player.angle);
    ctx.shadowBlur = 20; ctx.shadowColor = '#00d4ff';
    ctx.fillStyle = '#a0f0ff'; ctx.beginPath();
    ctx.moveTo(26, 0); ctx.lineTo(-14, -16); ctx.lineTo(-8, 0); ctx.lineTo(-14, 16); ctx.closePath(); ctx.fill();
    ctx.restore();

    ctx.restore();
    if (gameState === 'SPACE') { drawMinimap(); drawNavigation(); }
}

function drawPlanetSurface() {
    ctx.strokeStyle = 'rgba(255,255,255,0.03)'; ctx.lineWidth = 25;
    ctx.beginPath(); ctx.arc(0, 0, 1000, 0, Math.PI*2); ctx.stroke();
    planetResources.forEach(res => {
        if (!res.collected) {
            ctx.fillStyle = currentPlanet.color; ctx.shadowBlur = 18; ctx.shadowColor = currentPlanet.color;
            ctx.beginPath(); ctx.moveTo(res.x, res.y-12); ctx.lineTo(res.x+12, res.y+12); ctx.lineTo(res.x-12, res.y+12); ctx.fill();
        }
    });
    ctx.shadowBlur = 0;
}

function drawStation() {
    ctx.fillStyle = '#0a1a2a'; ctx.fillRect(-500, -500, 2000, 2000);
    for(let i=-400; i<=1400; i+=150) { ctx.strokeStyle = '#2a4a6a'; ctx.lineWidth = 0.5; ctx.beginPath(); ctx.moveTo(i, -400); ctx.lineTo(i, 1400); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-400, i); ctx.lineTo(1400, i); ctx.stroke(); }
    const drawZone = (x, y, color, label) => {
        ctx.fillStyle = '#1e2f3f'; ctx.fillRect(x, y, 120, 120);
        ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.strokeRect(x, y, 120, 120);
        ctx.fillStyle = '#fff'; ctx.font = "12px Orbitron"; ctx.fillText(label, x + 60, y + 65);
    };
    drawZone(90, 240, '#2ed573', "–í–ó–õ–ï–¢"); drawZone(640, 240, '#00d4ff', "–î–û–ö"); drawZone(440, 240, '#ffa502', "–†–´–ù–û–ö"); drawZone(340, 540, '#3742fa', "–ó–ê–î–ê–ù–ò–Ø");
}

function drawNavigation() {
    drawPointer(0, 0, '#00d4ff', "–ë–ê–ó–ê");
    if (activeQuest) {
        let tx, ty;
        if (activeQuest.type === 'collect') { const p = planets.find(pl => pl.ore === activeQuest.target); tx = p.x; ty = p.y; }
        else if(enemies.length > 0) { tx = enemies[0].x; ty = enemies[0].y; }
        if (tx !== undefined) drawPointer(tx, ty, '#ffcc00', "–¶–ï–õ–¨");
    }
}

function drawPointer(tx, ty, color, label) {
    if (Math.hypot(player.x - tx, player.y - ty) < 500) return;
    const angle = Math.atan2(ty - player.y, tx - player.x);
    ctx.save(); ctx.translate(canvas.width/2, canvas.height/2); ctx.rotate(angle);
    ctx.fillStyle = color; ctx.shadowBlur = 15; ctx.shadowColor = color;
    ctx.beginPath(); ctx.moveTo(180, 0); ctx.lineTo(160, -12); ctx.lineTo(168, 0); ctx.lineTo(160, 12); ctx.fill();
    ctx.restore();
}

function drawMinimap() {
    mCtx.fillStyle = '#03060a'; mCtx.fillRect(0,0,180,180);
    const z = 0.007, cx = 90;
    planets.forEach(p => { mCtx.fillStyle = p.color; mCtx.shadowBlur = 6; mCtx.shadowColor = p.color; mCtx.beginPath(); mCtx.arc(cx + (p.x - player.x)*z, cx + (p.y - player.y)*z, 3, 0, Math.PI*2); mCtx.fill(); });
    mCtx.shadowBlur = 0;
    mCtx.fillStyle = '#00d4ff'; mCtx.fillRect(cx-3, cx-3, 6, 6);
}

function populateShop() {
    const container = document.getElementById('shop-items');
    container.innerHTML = '';
    const upgrades = [
        { id: 'engine', name: '–¢—è–≥–æ–≤—ã–π –¥–≤–∏–≥–∞—Ç–µ–ª—å', cost: Math.floor(250 * Math.pow(2.1, player.upgrades.engine-1)) },
        { id: 'shield', name: '–°–∏—Å—Ç–µ–º–∞ —â–∏—Ç–æ–≤ (–¢–∏—Ä)', cost: Math.floor(500 * Math.pow(2.3, player.upgrades.shield-1)) },
        { id: 'damage', name: '–õ–∞–∑–µ—Ä–Ω—ã–µ –ø—É—à–∫–∏', cost: Math.floor(350 * Math.pow(1.9, player.upgrades.damage-1)) },
        { id: 'cargo', name: '–ì—Ä—É–∑–æ–≤–æ–π –º–æ–¥—É–ª—å', cost: Math.floor(200 * Math.pow(1.8, player.upgrades.cargo-1)) },
        { id: 'hull', name: '–£—Å–∏–ª–µ–Ω–∏–µ –∫–æ—Ä–ø—É—Å–∞', cost: Math.floor(300 * Math.pow(1.85, player.upgrades.hull-1)) }
    ];
    upgrades.forEach(u => {
        const div = document.createElement('div');
        div.className = "flex justify-between items-center p-3 bg-white/10 rounded border border-white/20";
        div.innerHTML = `<div><span class="font-bold text-white text-xs uppercase">${u.name} Lv.${player.upgrades[u.id]}</span></div>
            <button onclick="buyUpgrade('${u.id}', ${u.cost})" class="btn-sci-fi text-xs py-2 px-4" ${player.coins < u.cost ? 'disabled' : ''}>${u.cost} üí≥</button>`;
        container.appendChild(div);
    });
}

function buyUpgrade(type, cost) {
    if (player.coins >= cost) {
        player.coins -= cost; player.upgrades[type]++;
        if (type === 'damage') player.damage += 15;
        if (type === 'cargo') player.maxCargo += 10;
        if (type === 'hull') { player.maxHp += 60; player.hp = player.maxHp; }
        SFX.ui(); saveData(); populateShop();
    }
}

function openSell() {
    document.getElementById('sell-ui').style.display = 'block';
    if (player.cargo > 0) {
        const tier = TIERS.find(t => t.ore === player.cargoType);
        const price = player.cargo * (tier ? tier.price : 5);
        document.getElementById('sell-cargo-desc').innerText = `${player.cargo} –µ–¥. ${player.cargoType}`;
        document.getElementById('sell-price').innerText = price;
        document.getElementById('btn-sell-action').disabled = false;
    } else {
        document.getElementById('sell-cargo-desc').innerText = "–¢—Ä—é–º –ø—É—Å—Ç";
        document.getElementById('sell-price').innerText = "0";
        document.getElementById('btn-sell-action').disabled = true;
    }
}

function sellCargo() {
    const tier = TIERS.find(t => t.ore === player.cargoType);
    const price = player.cargo * (tier ? tier.price : 5);
    player.coins += price; player.cargo = 0; player.cargoType = null;
    SFX.pickup(); saveData(); openSell();
}

function acceptQuest() {
    const isKill = Math.random() > 0.5;
    if (isKill) activeQuest = { type: 'kill', goal: 5, progress: 0, reward: 180, desc: "–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –≤—Ä–∞–≥–æ–≤ –≤ —Å–µ–∫—Ç–æ—Ä–µ: " };
    else {
        const target = planets[Math.floor(Math.random() * Math.min(planets.length, player.upgrades.shield))];
        activeQuest = { type: 'collect', target: target.ore, goal: 7, progress: 0, reward: 250, desc: `–î–æ–±—ã—Ç—å ${target.ore}: ` };
    }
    closeDialog(); SFX.ui(); saveData();
}
function completeQuest() { player.coins += activeQuest.reward; activeQuest = null; SFX.ui(); saveData(); }

function updateUI() {
    document.getElementById('coins').innerText = Math.floor(player.coins);
    document.getElementById('cargo').innerText = player.cargo;
    document.getElementById('maxCargo').innerText = player.maxCargo;
    document.getElementById('hp-text').innerText = Math.ceil(player.hp);
    document.getElementById('max-hp-text').innerText = player.maxHp;
    document.getElementById('hp-bar').style.width = (player.hp / player.maxHp * 100) + '%';
    document.getElementById('eng-lvl').innerText = player.upgrades.engine;
    document.getElementById('shd-lvl').innerText = player.upgrades.shield;
    document.getElementById('dmg-lvl').innerText = player.upgrades.damage;
    document.getElementById('hull-lvl').innerText = player.upgrades.hull;
    document.getElementById('cargo-type').innerText = player.cargoType || "";
    if (activeQuest) {
        document.getElementById('quest-hud').style.display = 'block';
        document.getElementById('quest-desc').innerText = `${activeQuest.desc} ${activeQuest.progress}/${activeQuest.goal}`;
    } else document.getElementById('quest-hud').style.display = 'none';
    document.getElementById('sector-name').innerText = gameState === 'STATION' ? "–°–¢–ê–ù–¶–ò–Ø –ê–õ–¨–§–ê" : (gameState === 'SPACE' ? "–ì–õ–£–ë–û–ö–ò–ô –ö–û–°–ú–û–°" : currentPlanet.name);
}

function spawnParticle(x, y, color, size) { particles.push({ x, y, vx: (Math.random()-0.5)*2.5, vy: (Math.random()-0.5)*2.5, life: 1, color, size: 2*size }); }
function spawnExplosion(x, y, color, count) { for(let i=0; i<count*3; i++) spawnParticle(x, y, color, 1.8); }

function saveData() { 
    localStorage.setItem('nova_deep_save', JSON.stringify({ player, activeQuest })); 
    checkSaveData(); 
}

function closeDialog() { document.getElementById('dialog-ui').style.display = 'none'; }
function closeShop() { document.getElementById('shop-ui').style.display = 'none'; }
function closeSell() { document.getElementById('sell-ui').style.display = 'none'; }
function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }

init();
</script>
</body>
</html>
